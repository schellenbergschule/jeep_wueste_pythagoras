
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeep-Abenteuer ‚Äì W√ºsten-Graph (neu, stabile Aufgaben)</title>
  <style>
    :root{
      --sand-50:#fff8e6;--sand-100:#fff2d1;--sand-200:#fbe7b5;--sand-300:#eed39a;--sand-400:#d7b97c;--sand-500:#c3a56a;
      --edge:#b68a3a;--edge-visited:#b34d1e;--edge-label:#5d430f;--accent:#1f6f8b;--accent-2:#b34d1e
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(180deg,var(--sand-100),var(--sand-50));color:#2b2b2b}
    header{display:flex;align-items:center;justify-content:space-between;padding:.9rem 1.2rem;background:linear-gradient(180deg,var(--sand-400),var(--sand-300));border-bottom:3px solid var(--sand-500);position:sticky;top:0;z-index:10}
    .title{display:flex;gap:.6rem;align-items:center;font-weight:800}
    .container{max-width:1200px;margin:0 auto;padding:1rem 1.25rem 2rem}
    .hud{display:grid;grid-template-columns:1.4fr .8fr .8fr auto;gap:.8rem;align-items:center;margin-bottom:.8rem}
    .fuel{position:relative;height:30px;border-radius:12px;border:2px solid var(--sand-500);overflow:hidden;background:rgba(0,0,0,.08)}
    .fuel .bar{position:absolute;inset:0 0 0 0;width:10%;background:linear-gradient(90deg,#76c893,#4caf50);transition:width .25s ease}
    .fuel .label{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:800;text-shadow:0 1px 0 rgba(255,255,255,.7)}
    .stat{background:rgba(0,0,0,.06);border:2px solid var(--sand-500);border-radius:10px;padding:.5rem .75rem;text-align:center;font-weight:700}
    .btn{appearance:none;border:none;border-radius:10px;padding:.55rem .85rem;font-weight:800;cursor:pointer;color:#fff;background:var(--accent);box-shadow:0 2px 0 #155063}
    .btn.secondary{background:var(--accent-2);box-shadow:0 2px 0 #7f3715}
    .mapCard{border:3px solid var(--sand-500);border-radius:18px;background:var(--sand-50);box-shadow:0 8px 0 rgba(0,0,0,.08)}
    #edges line{stroke:var(--edge);stroke-width:3;stroke-linecap:round;opacity:.75}
    #edges line.used{stroke:var(--edge-visited);opacity:1;stroke-width:4}
    .edge-label{font-size:13px;font-weight:800;fill:var(--edge-label);paint-order:stroke;stroke:rgba(255,255,255,.9);stroke-width:3}
    .edge-label.used{fill:var(--edge-visited)}
    .reachable circle{stroke:#ff9800 !important;stroke-width:3 !important}
    .currentMarker circle{stroke:#000;stroke-width:3}
    .legend{display:flex;gap:1rem;align-items:center;padding:.6rem 1rem;border-top:3px solid var(--sand-500)}
    .dot{width:16px;height:16px;border-radius:50%;display:inline-block;border:2px solid #5d430f}
    .dot.base{background:#e6f3f7;border-color:#1f6f8b}.dot.normal{background:#ffe9b8}.dot.visited{background:#c7f2c7;border-color:#2e7d32}.dot.exit{background:#fff;border-color:#000}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:100;padding:1rem}
    .overlay.show{display:flex}
    .modal{max-width:760px;width:min(760px,92vw);background:#fffdf8;border-radius:16px;border:3px solid var(--sand-500);box-shadow:0 14px 40px rgba(0,0,0,.25);padding:1rem 1rem 1.25rem}
    .modal h2{margin:.25rem 0 .5rem}
    .row{display:flex;gap:.5rem;align-items:center}
    .modal input{padding:.6rem .7rem;font-size:1rem;border-radius:10px;border:2px solid var(--sand-500);flex:1}
    #toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:.6rem .9rem;border-radius:10px;opacity:0;pointer-events:none;transition:opacity .25s ease;z-index:200}
    #toast.show{opacity:1}
  </style>
</head>
<body>
  <header>
    <div class="title"><span style="font-size:1.4rem">üöó</span>Jeep-Abenteuer ‚Äì W√ºsten-Graph (neu)</div>
    <div class="subtitle">Aufgaben erscheinen bei jedem Ankommen. Start 10 L. Belohnung +2/+3 L.</div>
  </header>

  <div class="container">
    <div class="hud">
      <div class="fuel" aria-label="Tankanzeige"><div id="fuelBar" class="bar"></div><div id="fuelLabel" class="label">10 L</div></div>
      <div class="stat">Z√ºge: <span id="moves">0</span></div>
      <div class="stat">Besuchte Orte: <span id="visited">0</span>/20</div>
      <button id="resetBtn" class="btn secondary">Neu starten</button>
    </div>

    <div class="mapCard">
      <svg id="desert" viewBox="0 0 1200 800" width="100%" height="auto" aria-label="W√ºstenkarte">
        <defs>
          <linearGradient id="skyGrad" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#ffe6b0"/><stop offset="60%" stop-color="#fff1d6"/><stop offset="100%" stop-color="#fff8e6"/></linearGradient>
          <linearGradient id="duneGrad" x1="0" y1="0" x2="1" y2="0"><stop offset="0%" stop-color="#f2d59b"/><stop offset="100%" stop-color="#e0c084"/></linearGradient>
          <radialGradient id="oasisGrad" cx="50%" cy="50%" r="60%"><stop offset="0%" stop-color="#c3f6d8"/><stop offset="70%" stop-color="#9bd8b4"/><stop offset="100%" stop-color="#79b695"/></radialGradient>
          <filter id="markerShadow" x="-50%" y="-50%" width="200%" height="200%"><feDropShadow dx="0" dy="1" stdDeviation="2" flood-color="rgba(0,0,0,.35)"/></filter>
        </defs>
        <rect x="0" y="0" width="1200" height="800" fill="url(#skyGrad)"/>
        <circle cx="1020" cy="120" r="50" fill="#ffd36b" opacity="0.6"/>
        <path d="M0,520 C200,470 350,520 520,500 C760,470 900,520 1200,480 L1200,800 L0,800 Z" fill="url(#duneGrad)" opacity="0.8"/>
        <path d="M0,620 C250,570 420,640 600,610 C840,570 980,630 1200,600 L1200,800 L0,800 Z" fill="url(#duneGrad)" opacity="0.7"/>
        <ellipse cx="260" cy="360" rx="60" ry="35" fill="url(#oasisGrad)" opacity="0.85"/>
        <ellipse cx="910" cy="420" rx="70" ry="38" fill="url(#oasisGrad)" opacity="0.85"/>
        <g id="edges"></g>
        <polyline id="route" points="" fill="none" stroke="var(--edge-visited)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" opacity="0.9"/>
        <!-- Marker werden per JS gesetzt -->
      </svg>
      <div class="legend">
        <div class="item"><span class="dot normal"></span> Ort</div>
        <div class="item"><span class="dot visited"></span> besucht</div>
        <div class="item"><span class="dot base"></span> Basisstation</div>
        <div class="item"><span class="dot exit"></span> Ausgang</div>
      </div>
    </div>

    <p class="hint">‚ÑπÔ∏è Jede Verbindung zeigt die <strong>Spritkosten</strong> (‚âà Distanz/90). Aufgaben erscheinen <strong>immer</strong> beim Ankommen. Richtige L√∂sung: <strong>+2 oder +3 L</strong>. Start: <strong>10 L</strong>. Toleranz ¬±0,01.</p>
  </div>

  <!-- Start -->
  <div id="startOverlay" class="overlay show"><div class="modal centered"><h2>Jeep bereit.</h2><p>Fahre nur entlang <strong>verbundener</strong> Orte. Aufgaben: Hypotenuse oder Kathete; rechter Winkel zuf√§llig bei A/B/C.</p><div class="row" style="justify-content:center"><button id="startBtn" class="btn">Spiel starten</button></div></div></div>

  <!-- Task -->
  <div id="taskOverlay" class="overlay">
    <div class="modal">
      <h2 id="taskTitle">Ort</h2>
      <p id="taskText">Aufgabe</p>
      <div class="row"><input id="answerInput" type="text" inputmode="decimal" placeholder="Deine L√∂sung (z. B. 14.14)"/><button id="submitAnswer" class="btn">Antwort pr√ºfen</button></div>
      <p class="hint">Toleranz ¬±0,01 | Dezimal: Punkt oder Komma</p>
      <div class="row" style="justify-content:flex-end"><button id="closeTask" class="btn secondary">Schlie√üen</button></div>
    </div>
  </div>

  <!-- Heli -->
  <div id="heliOverlay" class="overlay"><div class="modal"><h2>‚úàÔ∏è Helikopter-Rettung</h2><p>Baum 12 m, Schatten 16 m ‚Üí Entfernung Spitze‚ÄìSchattenende?</p><div class="row"><input id="heliInput" type="text" inputmode="decimal" placeholder="z. B. 20"/><button id="heliSubmit" class="btn">Antwort pr√ºfen</button></div><p class="hint">Pythagoras, Toleranz ¬±0,01. Richtig: +20 L.</p></div></div>

  <!-- Ende -->
  <div id="endOverlay" class="overlay"><div class="modal centered"><h2 id="endTitle">Mission</h2><p id="endText">Ergebnis</p><p>Punkte: <strong id="score">0</strong></p><div class="row" style="justify-content:center"><button id="playAgain" class="btn">Nochmal spielen</button></div></div></div>

  <div id="toast" role="status" aria-live="polite"></div>

  <script>
    // ------------------ Daten ------------------
    const locations = [
      { name: "Oase der Ruhe", a:3, b:4 }, { name: "Verlassene Tankstelle", a:6, b:8 }, { name: "Ruine des K√∂nigs", a:5, b:12 },
      { name: "Sandd√ºnen-Pass", a:7, b:24 }, { name: "Kamelpfad", a:9, b:12 }, { name: "Alte Karawanserei", a:8, b:15 },
      { name: "Schattental", a:10, b:10 }, { name: "Fata Morgana", a:12, b:16 }, { name: "Salzsee", a:20, b:21 },
      { name: "Steinbruch", a:15, b:36 }, { name: "Nomadenlager", a:9, b:40 }, { name: "Windschlucht", a:11, b:60 },
      { name: "Sonnenplateau", a:13, b:84 }, { name: "D√ºnenmeer", a:18, b:24 }, { name: "Oase der Hoffnung", a:21, b:28 },
      { name: "Geisterstadt", a:5, b:5 }, { name: "Sandsturmzone", a:14, b:48 }, { name: "Verborgene Quelle", a:30, b:40 },
      { name: "Schlucht der Schatten", a:24, b:32 }, { name: "Basisstation", a:36, b:48 }
    ];
    const coords = [
      [250,350],[430,300],[150,220],[600,280],[780,320],[360,460],[540,380],
      [900,420],[1030,360],[840,220],[1060,520],[980,180],[700,160],
      [620,540],[420,560],[280,520],[780,600],[260,420],[520,620],[1000,680]
    ];
    const START = { name: 'Jeep-Start', coord:[100,700] };
    const EXIT  = { name: 'Ausgang der W√ºste', coord:[1140,700] };

    // Mehr Querverbindungen, mehrere Exit-Optionen
    const adj = {
      'S':['L0'], 'E':['L19','L10','L8'],
      'L0':['S','L2','L17','L5','L1'], 'L2':['L0','L1'], 'L1':['L0','L2','L3','L5','L6'],
      'L3':['L1','L6','L12','L4','L9'], 'L6':['L1','L3','L5','L13','L4'], 'L5':['L0','L1','L17','L14','L6','L13'],
      'L17':['L0','L5','L15'], 'L15':['L17','L14'], 'L14':['L5','L15','L13','L18'], 'L13':['L6','L5','L14','L18','L16'],
      'L18':['L14','L13','L16'], 'L16':['L13','L18','L10','L19'], 'L10':['L16','L7','L8','E'], 'L19':['L16','E'],
      'L7':['L8','L10','L4','L9'], 'L8':['L7','L11','L10','E'], 'L11':['L9','L12','L8'], 'L9':['L12','L3','L7','L11'], 'L12':['L3','L9','L11','L4'], 'L4':['L3','L12','L7']
    };

    // ------------------ State ------------------
    let fuel = 10; let moves = 0; let visited = new Set(); let baseVisited=false; let heliUsed=false; let gameOver=false;
    let currentKey = 'S';
    let currentTask = null; // {index, rightAngle, values, unknown, expected}
    let pendingHeli = false;

    // ------------------ Elemente ------------------
    const svg = document.getElementById('desert');
    const edgesLayer = document.getElementById('edges');
    const route = document.getElementById('route');
    const fuelBar = document.getElementById('fuelBar');
    const fuelLabel = document.getElementById('fuelLabel');
    const movesEl = document.getElementById('moves');
    const visitedEl = document.getElementById('visited');
    const toast = document.getElementById('toast');

    const startOverlay = document.getElementById('startOverlay');
    const startBtn = document.getElementById('startBtn');

    const taskOverlay = document.getElementById('taskOverlay');
    const taskTitle = document.getElementById('taskTitle');
    const taskText = document.getElementById('taskText');
    const answerInput = document.getElementById('answerInput');
    const submitAnswer = document.getElementById('submitAnswer');
    const closeTask = document.getElementById('closeTask');

    const heliOverlay = document.getElementById('heliOverlay');
    const heliInput = document.getElementById('heliInput');
    const heliSubmit = document.getElementById('heliSubmit');

    const endOverlay = document.getElementById('endOverlay');
    const endTitle = document.getElementById('endTitle');
    const endText = document.getElementById('endText');
    const scoreEl = document.getElementById('score');
    const playAgain = document.getElementById('playAgain');

    document.getElementById('resetBtn').addEventListener('click', resetGame);
    startBtn.addEventListener('click', ()=> startOverlay.classList.remove('show'));
    submitAnswer.addEventListener('click', checkAnswer);
    closeTask.addEventListener('click', ()=>{ taskOverlay.classList.remove('show'); if (pendingHeli && !heliUsed) { pendingHeli=false; showHelicopter(); }});
    heliSubmit.addEventListener('click', onHeliSubmit);
    playAgain.addEventListener('click', ()=>{ endOverlay.classList.remove('show'); resetGame(); startOverlay.classList.add('show'); });

    // ------------------ Utils ------------------
    function keyToCoord(k){ if(k==='S')return START.coord; if(k==='E')return EXIT.coord; return coords[parseInt(k.slice(1))]; }
    function keyToName(k){ if(k==='S')return START.name; if(k==='E')return EXIT.name; return locations[parseInt(k.slice(1))].name; }
    function edgePairKey(a,b){ return a<b?`${a}-${b}`:`${b}-${a}`; }
    function computeEdgeCost(a,b){ const [x1,y1]=keyToCoord(a),[x2,y2]=keyToCoord(b); const dist=Math.hypot(x2-x1,y2-y1); return Math.max(1, Math.round(dist/90)); }
    function rewardLiters(){ return 2 + Math.floor(Math.random()*2); } // 2 oder 3
    function showToast(msg){ toast.textContent=msg; toast.classList.add('show'); clearTimeout(showToast._t); showToast._t=setTimeout(()=>toast.classList.remove('show'),2000); }
    function parseNumber(str){ if(!str) return null; const v=parseFloat((str+'').trim().replace(',','.')); return Number.isFinite(v)?v:null; }

    // ------------------ Rendering ------------------
    function renderEdges(){
      edgesLayer.innerHTML=''; const done=new Set();
      Object.keys(adj).forEach(a=>{ adj[a].forEach(b=>{ const pk=edgePairKey(a,b); if(done.has(pk))return; done.add(pk); const [x1,y1]=keyToCoord(a),[x2,y2]=keyToCoord(b);
        const cost=computeEdgeCost(a,b);
        const line=document.createElementNS('http://www.w3.org/2000/svg','line'); line.setAttribute('x1',x1); line.setAttribute('y1',y1); line.setAttribute('x2',x2); line.setAttribute('y2',y2); line.setAttribute('data-pair',pk); edgesLayer.appendChild(line);
        const label=document.createElementNS('http://www.w3.org/2000/svg','text'); const mx=(x1+x2)/2,my=(y1+y2)/2; label.setAttribute('x',mx); label.setAttribute('y',my-6); label.setAttribute('text-anchor','middle'); label.setAttribute('class','edge-label'); label.setAttribute('data-pair',pk); label.textContent=cost+' L'; edgesLayer.appendChild(label);
      });});
    }

    function renderMarkers(){
      [...svg.querySelectorAll('.marker')].forEach(m=>m.remove());
      function makeMarker(key,isBase=false){ const [x,y]=keyToCoord(key); const g=document.createElementNS('http://www.w3.org/2000/svg','g'); g.classList.add('marker'); g.setAttribute('transform',`translate(${x},${y})`); g.setAttribute('data-key',key); g.style.cursor='pointer';
        const r = key==='S'||key==='E'||isBase?14:11;
        const c=document.createElementNS('http://www.w3.org/2000/svg','circle'); c.setAttribute('r',r); c.setAttribute('cx',0); c.setAttribute('cy',0);
        if(key==='S'||key==='E'){ c.setAttribute('fill','#fff'); c.setAttribute('stroke','#000'); c.setAttribute('stroke-width','3'); }
        else if(isBase){ c.setAttribute('fill','#e6f3f7'); c.setAttribute('stroke','#1f6f8b'); c.setAttribute('stroke-width','3'); }
        else{ c.setAttribute('fill','#ffe9b8'); c.setAttribute('stroke','#5d430f'); c.setAttribute('stroke-width','2'); }
        c.setAttribute('filter','url(#markerShadow)');
        const t=document.createElementNS('http://www.w3.org/2000/svg','text'); t.textContent=keyToName(key); t.setAttribute('x',0); t.setAttribute('y',-r-10); t.setAttribute('text-anchor','middle'); t.setAttribute('font-size','13'); t.setAttribute('font-weight','700'); t.setAttribute('fill','#503a0e'); t.setAttribute('paint-order','stroke'); t.setAttribute('stroke','rgba(255,255,255,.85)'); t.setAttribute('stroke-width','3');
        g.appendChild(c); g.appendChild(t);
        if(key==='S') g.addEventListener('click',()=>showToast('Startpunkt. W√§hle einen verbundenen Ort.'));
        else if(key==='E') g.addEventListener('click', onExitClick);
        else { const idx=parseInt(key.slice(1)); g.addEventListener('click', ()=>onLocationClick(idx)); }
        svg.appendChild(g);
      }
      makeMarker('S'); locations.forEach((loc,i)=>makeMarker('L'+i, loc.name==='Basisstation')); makeMarker('E');
      updateReachableVisual(); updateVisitedMarkers();
    }

    function updateVisitedMarkers(){
      svg.querySelectorAll('.marker').forEach(g=>{
        const key=g.getAttribute('data-key'); if(!key.startsWith('L')) return; const idx=parseInt(key.slice(1)); const circle=g.querySelector('circle');
        const was=visited.has(idx); const isBase=(locations[idx].name==='Basisstation');
        circle.setAttribute('fill', was? '#c7f2c7' : (isBase? '#e6f3f7' : '#ffe9b8'));
        circle.setAttribute('stroke', was? '#2e7d32' : (isBase? '#1f6f8b':'#5d430f'));
        circle.setAttribute('stroke-width', was||isBase ? '3':'2');
      });
    }

    function updateReachableVisual(){
      svg.querySelectorAll('.marker').forEach(g=>g.classList.remove('currentMarker','reachable'));
      const cur = svg.querySelector(`.marker[data-key="${currentKey}"]`); if(cur) cur.classList.add('currentMarker');
      (adj[currentKey]||[]).forEach(k=>{ const el=svg.querySelector(`.marker[data-key="${k}"]`); if(el) el.classList.add('reachable'); });
    }

    function markEdgeUsed(a,b){ const pk=edgePairKey(a,b); const line=edgesLayer.querySelector(`line[data-pair='${pk}']`); const lab=edgesLayer.querySelector(`text[data-pair='${pk}']`); if(line) line.classList.add('used'); if(lab) lab.classList.add('used'); }
    function appendToRoute(key){ const [x,y]=keyToCoord(key); const pts=(route.getAttribute('points')||'').trim(); route.setAttribute('points', (pts?pts+' ':'')+`${x},${y}`); }

    // ------------------ Aufgaben: Generator ------------------
    function generateTask(index){
      const baseA=locations[index].a, baseB=locations[index].b, hyp=Math.hypot(baseA,baseB);
      const ra = ['A','B','C'][Math.floor(Math.random()*3)];
      let values;
      if(ra==='C') values={a:baseA,b:baseB,c:hyp};
      else if(ra==='A') values={a:hyp,b:baseA,c:baseB};
      else values={a:baseA,b:hyp,c:baseB};
      const unknown = ['a','b','c'][Math.floor(Math.random()*3)];
      const expected = expectedFor({rightAngle:ra, values, unknown});
      return {index, rightAngle:ra, values, unknown, expected};
    }
    function expectedFor(task){
      const hypVar = (task.rightAngle==='A'?'a':task.rightAngle==='B'?'b':'c');
      if(task.unknown===hypVar){
        const legs=['a','b','c'].filter(s=>s!==hypVar); return Math.hypot(task.values[legs[0]], task.values[legs[1]]);
      } else {
        const otherLeg=['a','b','c'].find(s=>s!==hypVar && s!==task.unknown); const h=task.values[hypVar];
        return Math.sqrt(Math.max(0, h*h - task.values[otherLeg]*task.values[otherLeg]));
      }
    }
    function taskHtml(task){
      const fmt=v=>v.toFixed(2).replace('.',',');
      const val=(s)=> s===task.unknown? '?': fmt(task.values[s]);
      return `Rechter Winkel bei <strong>${task.rightAngle}</strong>.<br>Gegeben: a=<strong>${val('a')}</strong>, b=<strong>${val('b')}</strong>, c=<strong>${val('c')}</strong>.<br>Berechne <strong>${task.unknown}</strong>.`;
    }

    // ------------------ Game Flow ------------------
    function onLocationClick(index){
      if(gameOver) return;
      const key='L'+index; const reachable=(adj[currentKey]||[]).includes(key); if(!reachable){ showToast('Nicht verbunden.'); return; }
      const cost = computeEdgeCost(currentKey, key);
      fuel -= cost; moves += 1; appendToRoute(key); markEdgeUsed(currentKey,key); currentKey = key;
      updateFuel(); updateStats(); showToast(`Fahrt: -${cost} L`);
      pendingHeli = (fuel <= 0 && !heliUsed);

      // *** Aufgaben-Dialog IMMER √∂ffnen (robuste, synchrone Anzeige) ***
      openTaskFor(index);
    }

    function onExitClick(){
      if(gameOver) return; const key='E'; const reachable=(adj[currentKey]||[]).includes(key); if(!reachable){ showToast('Ausgang hier nicht erreichbar.'); return; }
      const cost=computeEdgeCost(currentKey,key); fuel -= cost; moves+=1; appendToRoute(key); markEdgeUsed(currentKey,key); currentKey=key; updateFuel(); updateStats(); showToast(`Fahrt zum Ausgang: -${cost} L`);
      if(fuel<=0 && !heliUsed){ pendingHeli=true; showHelicopter(); } else { endGame(true,'Du hast die W√ºste verlassen!'); }
    }

    function openTaskFor(index){
      currentTask = generateTask(index);
      taskTitle.textContent = locations[index].name;
      taskText.innerHTML = taskHtml(currentTask);
      answerInput.value='';
      taskOverlay.classList.add('show');
      // Focus nach Layout-Frame (robust in Safari/Firefox/Chrome)
      setTimeout(()=>answerInput.focus(), 0);
    }

    function checkAnswer(){
      if(!currentTask) return;
      const val = parseNumber(answerInput.value); if(val==null){ showToast('Bitte Zahl eingeben.'); return; }
      const ok = Math.abs(val - currentTask.expected) <= 0.01;
      if(ok){
        const idx = currentTask.index;
        const firstTime = !visited.has(idx);
        if(firstTime){ const gain = rewardLiters(); fuel += gain; visited.add(idx); if(locations[idx].name==='Basisstation') baseVisited=true; showToast(`Richtig! +${gain} L`); }
        else { showToast('Richtig! (keine zus√§tzliche Belohnung)'); }
        updateVisitedMarkers();
      } else {
        showToast('Leider falsch.');
      }
      updateFuel(); updateStats();
      taskOverlay.classList.remove('show'); currentTask=null;
      if(fuel<=0 && !heliUsed){ pendingHeli=false; showHelicopter(); return; }
      // Win-Checks optional: Exit bleibt prim√§res Ziel
    }

    function showHelicopter(){ heliInput.value=''; heliOverlay.classList.add('show'); setTimeout(()=>heliInput.focus(),0); showToast('Sprit leer! Helikopter-Aufgabe.'); }
    function onHeliSubmit(){ const v=parseNumber(heliInput.value); if(v==null){showToast('Bitte Zahl eingeben.'); return;} const correct=Math.hypot(12,16); if(Math.abs(v-correct)<=0.01){ fuel+=20; heliUsed=true; updateFuel(); showToast('+20 L'); heliOverlay.classList.remove('show'); } else { heliUsed=true; heliOverlay.classList.remove('show'); endGame(false,'Die Rettung ist gescheitert.'); } }

    function endGame(success, reason=''){
      gameOver=true; endTitle.textContent = success? 'Mission geschafft!':'Du bist gestrandet‚Ä¶'; endText.textContent = reason || (success?'Gut gemacht!':''); const score=Math.max(0, Math.round(100 + fuel - moves*3)); scoreEl.textContent=score; endOverlay.classList.add('show');
    }

    function updateFuel(){ const pct=Math.max(0,Math.min(100, fuel)); fuelBar.style.width=pct+'%'; if(fuel<=3) fuelBar.style.background='linear-gradient(90deg,#f44336,#e53935)'; else if(fuel<=6) fuelBar.style.background='linear-gradient(90deg,#ff9800,#fb8c00)'; else fuelBar.style.background='linear-gradient(90deg,#76c893,#4caf50)'; fuelLabel.textContent=Math.round(fuel)+' L'; }
    function updateStats(){ movesEl.textContent=moves; visitedEl.textContent=visited.size; updateReachableVisual(); }

    function resetGame(){ fuel=10; moves=0; visited=new Set(); baseVisited=false; heliUsed=false; gameOver=false; currentKey='S'; currentTask=null; pendingHeli=false; route.setAttribute('points', `${START.coord[0]},${START.coord[1]}`); edgesLayer.querySelectorAll('line.used').forEach(el=>el.classList.remove('used')); edgesLayer.querySelectorAll('text.edge-label.used').forEach(el=>el.classList.remove('used')); updateFuel(); updateStats(); taskOverlay.classList.remove('show'); heliOverlay.classList.remove('show'); endOverlay.classList.remove('show'); updateVisitedMarkers(); }

    // ------------------ Init ------------------
    function init(){ renderEdges(); renderMarkers(); route.setAttribute('points', `${START.coord[0]},${START.coord[1]}`); updateFuel(); updateStats(); }
    init();
  </script>
</body>
</html>
